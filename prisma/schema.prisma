generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String    @id @default(cuid())
  email                     String    @unique
  password                  String
  firstName                 String?
  lastName                  String?
  name                      String? // Legacy field, kept for backward compatibility
  systemRole                String?
  isPlatformAdmin           Boolean   @default(false)
  emailVerified             Boolean   @default(false)
  verificationToken         String?   @unique
  verificationTokenExpires  DateTime?
  passwordResetToken        String?   @unique
  passwordResetTokenExpires DateTime?
  totpSecret                String?
  totpEnabled               Boolean   @default(false)

  // Phase 1: Extended profile fields
  status            String    @default("active") // active | invited | suspended
  lastLoginAt       DateTime?
  jobTitle          String?
  phone             String?
  preferredLanguage String    @default("en")
  timeZone          String?

  // Phase 1: DEPRECATED - Nur für Cache/Performance, NICHT als Quelle der Wahrheit verwenden!
  // Die einzige Quelle der Wahrheit für Organisationsmitgliedschaften ist das Membership-Modell.
  // organizationId wird automatisch aus der ersten Membership abgeleitet (siehe Migration).
  organizationId String?
  organization   Organization? @relation("OrganizationUsers", fields: [organizationId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  dppPermissions    DppPermission[]
  publishedVersions DppVersion[]
  memberships       Membership[] // EINZIGE QUELLE DER WAHRHEIT für Organisationsmitgliedschaften und Rollen
  auditLogs         PlatformAuditLog[]
  invitations       Invitation[] // Invitations sent by this user
  notifications     Notification[]
  joinRequests      JoinRequest[]

  @@index([organizationId])
  @@index([status])
  @@map("users")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  licenseTier String   @default("free")
  status      String   @default("active")

  // Phase 1: Company Details (legal & operational)
  legalName            String?
  companyType          String? // e.g., "GmbH", "AG", "UG", "Ltd", etc.
  vatId                String? // VAT/UID number
  commercialRegisterId String? // Handelsregisternummer
  addressStreet        String?
  addressZip           String?
  addressCity          String?
  addressCountry       String?
  country              String? // ISO country code

  // Phase 1: Billing Information (separate from company details)
  billingEmail          String?
  billingContactUserId  String? // Reference to User.id
  invoiceAddressStreet  String?
  invoiceAddressZip     String?
  invoiceAddressCity    String?
  invoiceAddressCountry String?
  billingCountry        String? // Tax-relevant country

  // Relations
  dpps         Dpp[]
  memberships  Membership[] // EINZIGE QUELLE DER WAHRHEIT für Organisationsmitgliedschaften
  users        User[]             @relation("OrganizationUsers") // DEPRECATED: Nur für Cache, verwende memberships statt users
  subscription Subscription?
  auditLogs    PlatformAuditLog[]
  invitations  Invitation[]
  joinRequests JoinRequest[]

  @@index([status])
  @@index([country])
  @@map("organizations")
}

model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           String       @default("VIEWER") // Phase 1: ORG_ADMIN | EDITOR | VIEWER
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // EINZIGE QUELLE DER WAHRHEIT: Jede Organisationsmitgliedschaft MUSS hier existieren
  // Ein Nutzer kann mehrere Organisationsmitgliedschaften haben (Multi-Tenant)
  // Pro Nutzer und Organisation darf es nur EINE Mitgliedschaft geben
  
  @@unique([userId, organizationId])
  @@index([role])
  @@index([organizationId]) // Für schnelle Abfragen der Team-Mitglieder
  @@map("memberships")
}

model Dpp {
  id                    String          @id @default(cuid())
  name                  String
  description           String?
  category              String          @default("OTHER")
  sku                   String?
  gtin                  String?
  brand                 String?
  countryOfOrigin       String?
  materials             String?
  materialSource        String?
  careInstructions      String?
  isRepairable          String?
  sparePartsAvailable   String?
  lifespan              String?
  conformityDeclaration String?
  disposalInfo          String?
  takebackOffered       String?
  takebackContact       String?
  secondLifeInfo        String?
  status                String          @default("DRAFT") // DRAFT | PUBLISHED | DEPRECATED
  supersedesDppId       String? // ID des DPPs, der durch diesen DPP ersetzt wurde (für Fehlklassifikationen)
  organizationId        String
  // Template-Version-Binding (immutable nach Erstellung)
  templateId            String? // Template logical identifier (e.g. category-based)
  templateVersionId     String? // Template ID (specific version identifier - the actual Template.id)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  media                 DppMedia[]
  permissions           DppPermission[]
  versions              DppVersion[]
  content               DppContent[]
  contributorTokens     ContributorToken[]
  blockSupplierConfigs DppBlockSupplierConfig[]
  supplierInvites     DppSupplierInvite[]
  pollResponses       PollResponse[]
  organization          Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([templateVersionId])
  @@map("dpps")
}

model DppBlockSupplierConfig {
  id            String   @id @default(cuid())
  dppId         String
  dpp           Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  blockId       String   // TemplateBlock ID (Referenz, keine Foreign Key da TemplateBlock in anderer DB-Struktur)
  enabled       Boolean  @default(false)
  mode          String?  // "input" | "declaration"
  allowedRoles  Json?    // Array von Rollen (optional, als JSON gespeichert)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([dppId, blockId])
  @@index([dppId])
  @@map("dpp_block_supplier_configs")
}

model DppSupplierInvite {
  id              String    @id @default(cuid())
  dppId           String
  email           String
  name            String?
  company         String?
  message         String?
  partnerRole     String
  blockIds        Json      // string[] – Template-Block-IDs
  fieldInstances  Json      // FieldInstance[] – Feld-Instanzen
  supplierMode    String    // "input" | "declaration"
  status          String    @default("pending") // pending | submitted
  token           String?   @unique
  expiresAt       DateTime?
  emailSentAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  dpp             Dpp       @relation(fields: [dppId], references: [id], onDelete: Cascade)

  @@index([dppId])
  @@index([token])
  @@map("dpp_supplier_invites")
}

model DppMedia {
  id         String   @id @default(cuid())
  dppId      String
  fileName   String
  fileType   String
  fileSize   Int
  storageUrl String
  uploadedAt DateTime @default(now())
  sortOrder  Int      @default(0) // Reihenfolge für Anzeige (erstes Bild = Hero)
  // Semantische Rolle: primary_product_image (Hero), gallery_image, certificate, logo, etc.
  role       String?
  // Zuordnung zu Template-Block und -Feld (optional für Legacy-Medien)
  blockId    String?  // TemplateBlock ID
  fieldId    String?  // TemplateField ID (key)
  fieldKey   String?  // Key des File-Felds im Block
  dpp        Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)

  @@index([dppId, blockId, fieldId])
  @@index([dppId, role])
  @@map("dpp_media")
}

model DppVersion {
  id                    String   @id @default(cuid())
  dppId                 String
  version               Int
  name                  String
  description           String?
  category              String
  sku                   String?
  gtin                  String?
  brand                 String?
  countryOfOrigin       String?
  materials             String?
  materialSource        String?
  careInstructions      String?
  isRepairable          String?
  sparePartsAvailable   String?
  lifespan              String?
  conformityDeclaration String?
  disposalInfo          String?
  takebackOffered       String?
  takebackContact       String?
  secondLifeInfo        String?
  createdAt             DateTime @default(now())
  createdByUserId       String
  publicUrl             String?
  qrCodeImageUrl        String?
  createdBy             User     @relation(fields: [createdByUserId], references: [id])
  dpp                   Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  media                 DppVersionMedia[]

  @@unique([dppId, version])
  @@map("dpp_versions")
}

model DppVersionMedia {
  id         String     @id @default(cuid())
  versionId  String
  fileName   String
  fileType   String
  fileSize   Int
  storageUrl String
  role       String?
  blockId    String?
  fieldKey   String?
  uploadedAt DateTime   @default(now())
  version    DppVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([versionId, role])
  @@index([blockId])
  @@map("dpp_version_media")
}

model PollResponse {
  id           String   @id @default(cuid())
  pollBlockId String   // ID des Poll-Blocks im DppContent.blocks JSON (keine FK)
  dppId       String
  responses   Json     // Array von Antworten pro Frage
  sessionId   String?
  createdAt   DateTime @default(now())
  dpp         Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)

  @@index([pollBlockId])
  @@index([dppId])
  @@index([dppId, pollBlockId])
  @@map("poll_responses")
}

model DppPermission {
  id        String   @id @default(cuid())
  dppId     String
  userId    String
  role      String
  sections  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  dpp       Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dppId, userId, role])
  @@map("dpp_permissions")
}

// Contributor Token: Scoped access token for supplier data requests
model ContributorToken {
  id           String   @id @default(cuid())
  token        String   @unique
  dppId        String
  dpp          Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  email        String
  partnerRole  String // Material supplier | Manufacturer | Processor | Recycler | Other
  sections     String? // DEPRECATED: Comma-separated list of allowed sections (legacy, use blockIds instead) - nullable für Backward Compatibility
  blockIds     String? // Comma-separated list of allowed TemplateBlock IDs (new template-based approach)
  supplierMode String? // "input" | "declaration" - how supplier should interact with fields
  message      String? // Optional message from DPP owner
  status       String   @default("pending") // pending | submitted | expired | confirmed
  expiresAt    DateTime
  submittedAt  DateTime?
  emailSentAt  DateTime? // Timestamp, wenn E-Mail erfolgreich verschickt wurde
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  requestedBy  String? // User ID who created the request
  submittedData Json? // Submitted data as JSON (template-based field values)

  @@index([token])
  @@index([dppId])
  @@index([email])
  @@index([status])
  @@index([expiresAt])
  @@map("contributor_tokens")
}

model SuperAdmin {
  id                        String              @id @default(cuid())
  email                     String              @unique
  passwordHash              String
  name                      String?
  role                      String              @default("support_admin")
  isActive                  Boolean             @default(true)
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  lastLoginAt               DateTime?
  passwordResetToken        String?             @unique
  passwordResetTokenExpires DateTime?
  auditLogs                 AuditLog[]
  twoFactorAuth             SuperAdmin2FA?
  sessions                  SuperAdminSession[]

  @@map("super_admins")
}

model SuperAdmin2FA {
  id           String     @id @default(cuid())
  superAdminId String     @unique
  secret       String
  enabled      Boolean    @default(false)
  backupCodes  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@map("super_admin_2fa")
}

model SuperAdminSession {
  id           String     @id @default(cuid())
  superAdminId String
  token        String     @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime   @default(now())
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@index([token])
  @@map("super_admin_sessions")
}

// Legacy SuperAdmin-only Audit Log (kept for backward compatibility)
model AuditLog {
  id           String     @id @default(cuid())
  superAdminId String
  action       String
  entityType   String
  entityId     String
  before       String?
  after        String?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime   @default(now())
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: SetNull)

  @@index([superAdminId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

// Comprehensive Platform Audit Log (ESPR-aligned, immutable, AI-aware)
model PlatformAuditLog {
  id                 String   @id @default(cuid())
  timestamp          DateTime @default(now())
  actorId            String? // User ID or "SYSTEM" for system actions
  actorRole          String? // SUPER_ADMIN | ORG_OWNER | ORG_ADMIN | ORG_MEMBER | ORG_VIEWER | SUPPLIER | SYSTEM | AI
  organizationId     String?
  actionType         String // CREATE | UPDATE | DELETE | PUBLISH | ARCHIVE | EXPORT | ROLE_CHANGE | USER_ADDED | USER_REMOVED | PERMISSION_CHANGED | AI_SUGGESTION_GENERATED | AI_SUGGESTION_ACCEPTED | AI_SUGGESTION_MODIFIED | AI_SUGGESTION_REJECTED | AI_AUTO_FILL_APPLIED | AI_ANALYSIS_RUN | AI_CONFIDENCE_SCORE_UPDATED
  entityType         String // DPP | DPP_VERSION | DPP_CONTENT | DPP_MEDIA | USER | ORGANIZATION | MEMBERSHIP | DPP_PERMISSION | TEMPLATE | PRICING_PLAN | SUBSCRIPTION_MODEL | PRICE | ENTITLEMENT | PRICING_PLAN_FEATURE | PRICING_PLAN_ENTITLEMENT
  entityId           String?
  fieldName          String? // Specific field that was changed (nullable for non-field-specific actions)
  oldValue           String? // JSON string of old value (nullable)
  newValue           String? // JSON string of new value (nullable)
  source             String // UI | API | IMPORT | AI | SYSTEM
  complianceRelevant Boolean  @default(false)
  versionId          String? // Link to DPP version if applicable
  ipAddress          String? // Masked for non-admins
  metadata           Json? // Extensible JSON metadata

  // AI-specific metadata (only populated when source = AI)
  aiModel              String?
  aiModelVersion       String?
  aiPromptId           String? // Reference ID only, never raw prompt text
  aiInputSources       String? // JSON array of strings
  aiConfidenceScore    Float? // 0-1
  aiExplainabilityNote String?
  humanInTheLoop       Boolean? @default(false)
  finalDecisionBy      String? // user_id or "SYSTEM"
  regulatoryImpact     String? // low | medium | high

  // Relations
  actor        User?         @relation(fields: [actorId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([timestamp])
  @@index([actorId])
  @@index([organizationId])
  @@index([actionType])
  @@index([entityType, entityId])
  @@index([source])
  @@index([complianceRelevant])
  @@index([organizationId, timestamp])
  @@index([entityType, entityId, timestamp])
  @@map("platform_audit_logs")
}

model Subscription {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                 String       @default("basic") // basic | pro | premium (legacy, deprecated)
  status               String       @default("trial_active") // trial_active | active | past_due | canceled | expired
  trialExpiresAt       DateTime? // Nullable, nur gesetzt wenn status = trial_active
  trialStartedAt       DateTime?
  stripeSubscriptionId String?      @unique
  stripeCustomerId     String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean      @default(false)
  canceledAt           DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  // New subscription model reference
  subscriptionModelId  String?
  subscriptionModel    SubscriptionModel?    @relation(fields: [subscriptionModelId], references: [id], onDelete: SetNull)
  priceSnapshotId      String?
  priceSnapshot        PriceSnapshot?        @relation(fields: [priceSnapshotId], references: [id], onDelete: SetNull)
  startedAt            DateTime? // When subscription actually started (after trial)
  entitlementSnapshots EntitlementSnapshot[]

  @@map("subscriptions")
}

model Feature {
  id                   String                @id @default(cuid())
  key                  String                @unique
  name                 String
  description          String?
  defaultEnabled       Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  organizationFeatures OrganizationFeature[]

  @@map("features")
}

model OrganizationFeature {
  id             String    @id @default(cuid())
  organizationId String
  featureId      String
  enabled        Boolean   @default(false)
  enabledAt      DateTime?
  disabledAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  feature        Feature   @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureId])
  @@index([organizationId])
  @@map("organization_features")
}

model Template {
  id                String          @id @default(cuid())
  name              String
  industry          String?
  version           Int             @default(1)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  category          String
  description       String?
  createdBy         String?
  status            String          @default("draft")
  effectiveFrom     DateTime?
  supersedesVersion Int?
  categoryLabel     String?
  blocks            TemplateBlock[]

  @@unique([category, version])
  @@unique([category, version, status])
  @@index([category])
  @@index([status])
  @@index([category, status])
  @@index([industry])
  @@map("templates")
}

model TemplateBlock {
  id            String          @id @default(cuid())
  templateId    String
  name          String
  order         Int             @default(0)
  // ENTFERNT: supplierConfig - wird jetzt pro DPP konfiguriert, nicht im Template
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  template      Template        @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fields        TemplateField[]

  @@index([templateId])
  @@index([templateId, order])
  @@map("template_blocks")
}

model TemplateField {
  id                  String        @id @default(cuid())
  blockId             String
  templateId          String
  label               String
  key                 String
  type                String
  required            Boolean       @default(false)
  config              String?
  order               Int           @default(0)
  isRepeatable        Boolean       @default(false) // Für wiederholbare Gruppen (z.B. Materialien)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  regulatoryRequired  Boolean       @default(false)
  introducedInVersion Int           @default(1)
  deprecatedInVersion Int?
  regulatoryMapping   String?
  block               TemplateBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@unique([templateId, key])
  @@index([blockId])
  @@index([templateId])
  @@index([blockId, order])
  @@map("template_fields")
}

model FeatureRegistry {
  id                           String      @id @default(cuid())
  key                          String      @unique
  name                         String
  description                  String?
  category                     String // core | content | interaction | styling | publishing | system
  capabilityKey                String? // Optional: Maps to capability (for compatibility)
  minimumPlan                  String // basic | pro | premium
  requiresActiveSubscription   Boolean     @default(true)
  requiresPublishingCapability Boolean     @default(false)
  visibleInTrial               Boolean     @default(true)
  usableInTrial                Boolean     @default(true)
  configSchema                 String? // JSON Schema als String
  enabled                      Boolean     @default(true)
  defaultForNewDpps            Boolean     @default(false)
  systemDefined                Boolean     @default(false) // True if defined in feature manifest
  createdAt                    DateTime    @default(now())
  updatedAt                    DateTime    @updatedAt
  blockTypes                   BlockType[]

  @@index([category])
  @@index([minimumPlan])
  @@index([systemDefined])
  @@map("feature_registry")
}

model BlockType {
  id                 String           @id @default(cuid())
  featureRegistryId  String?
  featureRegistry    FeatureRegistry? @relation(fields: [featureRegistryId], references: [id], onDelete: SetNull)
  key                String           @unique
  name               String
  description        String?
  category           String // content | interaction | styling
  configSchema       String // JSON Schema für Block Config
  defaultConfig      String? // Default JSON Config
  supportsStyling    Boolean          @default(false)
  requiresPublishing Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([category])
  @@map("block_types")
}

model DppContent {
  id          String   @id @default(cuid())
  dppId       String
  dpp         Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  versionId   String? // Optional: Link zu published version
  isPublished Boolean  @default(false)
  blocks      Json // Array von Block Objects
  styling     Json? // Global styling config (nur wenn capability vorhanden)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  @@index([dppId])
  @@index([dppId, isPublished])
  @@map("dpp_content")
}

// ============================================
// PRICING & SUBSCRIPTION SYSTEM
// ============================================

// Pricing Plan: Business configuration layer
model PricingPlan {
  id                   String   @id @default(cuid())
  name                 String
  slug                 String   @unique
  descriptionMarketing String? // Marketing description for public page
  isPublic             Boolean  @default(true)
  isActive             Boolean  @default(true)
  displayOrder         Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  features           PricingPlanFeature[]
  entitlements       PricingPlanEntitlement[]
  subscriptionModels SubscriptionModel[]

  @@index([isActive, isPublic])
  @@index([displayOrder])
  @@map("pricing_plans")
}

// Links Pricing Plan to Feature Registry (read-only reference)
model PricingPlanFeature {
  id            String      @id @default(cuid())
  pricingPlanId String
  pricingPlan   PricingPlan @relation(fields: [pricingPlanId], references: [id], onDelete: Cascade)
  featureKey    String // References FeatureRegistry.key (not a foreign key - read-only registry)
  included      Boolean     @default(true)
  note          String? // Optional note (e.g. "Coming soon")

  @@unique([pricingPlanId, featureKey])
  @@index([pricingPlanId])
  @@index([featureKey])
  @@map("pricing_plan_features")
}

// Entitlements: System-wide limit definitions
model Entitlement {
  id   String  @id @default(cuid())
  key  String  @unique // e.g. "max_dpp", "max_storage_gb"
  type String // "limit" | "boolean"
  unit String? // e.g. "count", "gb", "mb"

  @@map("entitlements")
}

// Links Pricing Plan to Entitlements with values
model PricingPlanEntitlement {
  id             String      @id @default(cuid())
  pricingPlanId  String
  pricingPlan    PricingPlan @relation(fields: [pricingPlanId], references: [id], onDelete: Cascade)
  entitlementKey String // References Entitlement.key
  value          Int? // null = unlimited

  @@unique([pricingPlanId, entitlementKey])
  @@index([pricingPlanId])
  @@index([entitlementKey])
  @@map("pricing_plan_entitlements")
}

// Subscription Model: Billing configuration (monthly/yearly, trial, etc.)
model SubscriptionModel {
  id                  String      @id @default(cuid())
  pricingPlanId       String
  pricingPlan         PricingPlan @relation(fields: [pricingPlanId], references: [id], onDelete: Cascade)
  billingInterval     String // "monthly" | "yearly"
  minCommitmentMonths Int? // Optional minimum commitment
  trialDays           Int         @default(0)
  isActive            Boolean     @default(true)
  stripePriceId       String?     @unique // Stripe Price ID
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  prices                    Price[]
  subscriptions             Subscription[]
  trialFeatureOverrides     TrialFeatureOverride[]
  trialEntitlementOverrides TrialEntitlementOverride[]

  @@index([pricingPlanId])
  @@index([isActive])
  @@map("subscription_models")
}

// Price: Versioned pricing (allows price changes over time)
model Price {
  id                  String            @id @default(cuid())
  subscriptionModelId String
  subscriptionModel   SubscriptionModel @relation(fields: [subscriptionModelId], references: [id], onDelete: Cascade)
  amount              Int // Price in smallest currency unit (cents)
  currency            String            @default("EUR")
  validFrom           DateTime          @default(now())
  validTo             DateTime? // null = currently valid
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())

  @@index([subscriptionModelId])
  @@index([isActive, validFrom, validTo])
  @@map("prices")
}

// Price Snapshot: Immutable snapshot created at checkout
model PriceSnapshot {
  id              String   @id @default(cuid())
  amount          Int // Price in smallest currency unit (cents)
  currency        String   @default("EUR")
  billingInterval String // "monthly" | "yearly"
  createdAt       DateTime @default(now())

  subscriptions Subscription[]

  @@map("price_snapshots")
}

// Entitlement Snapshot: Immutable snapshot created at checkout
model EntitlementSnapshot {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  key            String // Entitlement key (e.g. "max_dpp")
  value          Int? // null = unlimited
  createdAt      DateTime     @default(now())

  @@unique([subscriptionId, key])
  @@index([subscriptionId])
  @@index([key])
  @@map("entitlement_snapshots")
}

// Trial Feature Override: Configure which features are enabled/disabled during trial
model TrialFeatureOverride {
  id                  String            @id @default(cuid())
  subscriptionModelId String
  subscriptionModel   SubscriptionModel @relation(fields: [subscriptionModelId], references: [id], onDelete: Cascade)
  featureKey          String // References Feature Registry key
  enabled             Boolean           @default(false) // Feature enabled during trial
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([subscriptionModelId, featureKey])
  @@index([subscriptionModelId])
  @@index([featureKey])
  @@map("trial_feature_overrides")
}

// Trial Entitlement Override: Configure limits during trial
model TrialEntitlementOverride {
  id                  String            @id @default(cuid())
  subscriptionModelId String
  subscriptionModel   SubscriptionModel @relation(fields: [subscriptionModelId], references: [id], onDelete: Cascade)
  entitlementKey      String // e.g. "max_published_dpp", "max_storage_gb", "max_users"
  value               Int? // null = unlimited during trial
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([subscriptionModelId, entitlementKey])
  @@index([subscriptionModelId])
  @@index([entitlementKey])
  @@map("trial_entitlement_overrides")
}

// ============================================
// PHASE 1: ORGANIZATION & USER MANAGEMENT
// ============================================

// Invitation: Organization invites User via email
model Invitation {
  id             String       @id @default(cuid())
  email          String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @default("VIEWER") // ORG_ADMIN | EDITOR | VIEWER
  status         String       @default("pending") // pending | accepted | expired
  token          String       @unique
  expiresAt      DateTime
  invitedById    String? // User who sent the invitation
  invitedBy      User?        @relation(fields: [invitedById], references: [id], onDelete: SetNull)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([email, organizationId, status])
  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

// JoinRequest: User requests to join Organization
model JoinRequest {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status         String       @default("pending") // pending | approved | rejected
  message        String? // Optional message from user
  reviewedById   String? // User who reviewed the request
  reviewedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId, status])
  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@map("join_requests")
}

// Notification: User notifications with deep linking (event types in lib/notifications)
model Notification {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String // event key from NOTIFICATION_EVENT_KEYS
  referenceType   String?   // legacy / e.g. "join_request", "invitation"
  referenceId     String?   // legacy entity id
  read            Boolean   @default(false)
  readAt          DateTime? // set when marked as read (audit-friendly)
  createdAt       DateTime  @default(now())
  message         String?   // optional override for default template
  targetRoute     String?   // primary deep link e.g. /app/dpps/123
  targetEntityId  String?   // DPP id, org id, invitation id, etc.
  targetTab       String?   // optional tab/section
  organisationId  String?
  actorRole       String?   // supplier | editor | owner | admin | system

  @@index([userId])
  @@index([userId, read])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// Password Protection Config: Global password gate for Closed Alpha / Pre-Launch
model PasswordProtectionConfig {
  id                               String    @id @default(cuid())
  passwordProtectionEnabled        Boolean   @default(false)
  passwordProtectionStartDate      DateTime?
  passwordProtectionEndDate        DateTime?
  passwordProtectionPasswordHash   String?
  passwordProtectionSessionTimeoutMinutes Int @default(60)
  updatedAt                        DateTime  @updatedAt
  updatedBy                        String? // Super Admin ID

  @@map("password_protection_config")
}
