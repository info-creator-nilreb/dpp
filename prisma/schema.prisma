// Prisma Schema für T-Pass

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String       @id @default(cuid())
  email             String       @unique
  password          String       // bcrypt hash
  name              String?
  systemRole        String?      // System-Rolle: SUPER_ADMIN, EU_REGISTRY, null
  isPlatformAdmin   Boolean      @default(false) // DEPRECATED: Verwende systemRole statt dessen
  emailVerified     Boolean      @default(false) // E-Mail-Verifizierung
  verificationToken String?      @unique // Token für E-Mail-Verifizierung
  verificationTokenExpires DateTime? // Ablaufdatum des Tokens
  // Passwort-Reset
  passwordResetToken String?     @unique // Token für Passwort-Reset
  passwordResetTokenExpires DateTime? // Ablaufdatum des Reset-Tokens
  // Zwei-Faktor-Authentifizierung (2FA)
  totpSecret        String?      // TOTP-Secret für 2FA (nur für Super Admins)
  totpEnabled       Boolean      @default(false) // Ist 2FA aktiviert?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Many-to-Many: User kann Mitglied mehrerer Organisationen sein
  memberships     Membership[]
  
  // DPP-spezifische Permissions (externe Rollen)
  dppPermissions  DppPermission[]
  
  // Veröffentlichte DPP-Versionen (für Audit-Trail)
  publishedVersions DppVersion[]

  @@map("users")
}

model Organization {
  id          String       @id @default(cuid())
  name        String
  licenseTier String       @default("free") // free | basic | premium | pro
  status      String       @default("active") // active | suspended | archived
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Many-to-Many: Organization hat mehrere Mitglieder
  memberships Membership[]
  
  // DPPs gehören zu einer Organization
  dpps        Dpp[]

  @@map("organizations")
}

// Join-Tabelle für User ↔ Organization (Many-to-Many)
// Enthält die Organisations-Rolle des Users
model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           String       @default("ORG_MEMBER") // ORG_OWNER, ORG_ADMIN, ORG_MEMBER, ORG_VIEWER
  createdAt      DateTime     @default(now())

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Ein User kann nur einmal Mitglied einer Organisation sein
  @@unique([userId, organizationId])
  @@map("memberships")
}

// Digital Product Passport (DPP)
// WICHTIG: Dpp repräsentiert IMMER den Draft (editierbar)
// Veröffentlichte Versionen werden in DppVersion gespeichert
model Dpp {
  id             String   @id @default(cuid())
  // Basis- & Produktdaten (Pflicht)
  name           String   // Produktname
  description    String?  // Produktbeschreibung
  category       String   @default("OTHER") // Produktkategorie: TEXTILE, FURNITURE, OTHER
  sku            String?  // SKU / interne ID
  gtin           String?  // GTIN / EAN (optional)
  brand          String?  // Marke / Hersteller
  countryOfOrigin String? // Herstellungsland
  // Materialien & Zusammensetzung
  materials      String?  // Materialliste (Freitext)
  materialSource String?  // Datenquelle (z. B. Lieferant)
  // Nutzung, Pflege & Lebensdauer
  careInstructions String? // Pflegehinweise
  isRepairable   String?  // Reparierbarkeit: "YES", "NO", null
  sparePartsAvailable String? // Ersatzteile verfügbar: "YES", "NO", null
  lifespan       String?  // Lebensdauerangabe
  // Rechtliches & Konformität
  conformityDeclaration String? // Konformitätserklärung (Text)
  disposalInfo   String?  // Hinweise zu Entsorgung / Recycling
  // Rücknahme & Second Life
  takebackOffered String? // Rücknahme angeboten: "YES", "NO", null
  takebackContact String? // Kontakt / URL
  secondLifeInfo  String? // Second-Life-Informationen
  // Status & Organisation
  status         String   @default("DRAFT") // DRAFT = Entwurf, PUBLISHED = hat mind. 1 Version
  organizationId String   // Zugehörigkeit zur Organization
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Medien sind getrennt modelliert (1:N Beziehung)
  media          DppMedia[]
  
  // Versionen (veröffentlichte Versionen sind read-only)
  versions       DppVersion[]
  
  // DPP-spezifische Permissions (externe Rollen: SUPPLIER, RECYCLER, REPAIR_SERVICE)
  permissions    DppPermission[]

  @@map("dpps")
}

// Medien & Dokumente für DPPs
// WICHTIG: Getrenntes Modell für bessere Skalierbarkeit und Flexibilität
model DppMedia {
  id          String   @id @default(cuid())
  dppId       String   // Zugehörigkeit zum DPP (nur Draft, nicht zu Versionen)
  fileName    String   // Original-Dateiname
  fileType    String   // MIME-Type (z.B. "image/jpeg", "application/pdf")
  fileSize    Int      // Größe in Bytes
  storageUrl  String   // URL/Path zur Datei im Storage
  uploadedAt  DateTime @default(now())

  dpp         Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)

  @@map("dpp_media")
}

// Veröffentlichte Versionen eines DPPs
// WICHTIG: Unveränderlich (immutable), dient ESPR-Konformität & Audit-Trail
model DppVersion {
  id             String   @id @default(cuid())
  dppId          String   // Zugehörigkeit zum DPP (Draft)
  version        Int      // Fortlaufende Versionsnummer (1, 2, 3, ...)
  // Vollständige Kopie aller DPP-Daten (Snapshot)
  name           String
  description    String?
  category       String
  sku            String?
  gtin           String?
  brand          String?
  countryOfOrigin String?
  materials      String?
  materialSource String?
  careInstructions String?
  isRepairable   String?
  sparePartsAvailable String?
  lifespan       String?
  conformityDeclaration String?
  disposalInfo   String?
  takebackOffered String?
  takebackContact String?
  secondLifeInfo  String?
  // Metadaten für ESPR/Audit
  createdAt      DateTime @default(now()) // Veröffentlichungsdatum
  createdByUserId String  // Bearbeiter (User ID)
  
  // Public Access & QR-Code
  publicUrl      String?  // Öffentliche URL für diese Version (z.B. /public/dpp/[id]/v/[version])
  qrCodeImageUrl String?  // URL zum QR-Code-Bild (Storage-Pfad)
  
  dpp            Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  createdBy      User     @relation(fields: [createdByUserId], references: [id])

  // Eindeutigkeit: Ein DPP kann nur eine Version mit einer bestimmten Versionsnummer haben
  @@unique([dppId, version])
  @@map("dpp_versions")
}

// DPP-spezifische Permissions für externe Rollen
// Ermöglicht granulare Berechtigungen pro DPP (z.B. SUPPLIER kann nur Materialien bearbeiten)
model DppPermission {
  id        String   @id @default(cuid())
  dppId     String   // Zugehörigkeit zum DPP
  userId    String   // User mit dieser Permission
  role      String   // Externe Rolle: SUPPLIER, RECYCLER, REPAIR_SERVICE
  sections  String?  // Komma-separierte Liste erlaubter Sektionen (z.B. "materials,materialSource")
                     // null = alle Sektionen der Rolle
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dpp       Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ein User kann nur eine Permission-Rolle pro DPP haben
  @@unique([dppId, userId, role])
  @@map("dpp_permissions")
}

// ============================================================================
// SUPER ADMIN TABLES - COMPLETELY SEPARATE FROM TENANT SYSTEM
// ============================================================================
// WICHTIG: Diese Tabellen sind VOLLSTÄNDIG isoliert von User/Organization
// - Keine Foreign Keys zu User/Organization
// - Eigene Authentifizierung
// - Eigene Sessions
// - Eigene RLS Policies

// Super Admin Benutzer (isoliert von User-Tabelle)
model SuperAdmin {
  id                        String   @id @default(cuid())
  email                     String   @unique
  passwordHash              String   // bcrypt hash (KEIN "password" Feld, nur Hash)
  name                      String?
  role                      String   @default("support_admin") // super_admin | support_admin | read_only_admin
  isActive                  Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  lastLoginAt               DateTime?
  // Passwort-Reset
  passwordResetToken        String?  @unique // Token für Passwort-Reset
  passwordResetTokenExpires DateTime? // Ablaufdatum des Reset-Tokens

  // Relations
  twoFactorAuth  SuperAdmin2FA?
  auditLogs      AuditLog[]
  sessions       SuperAdminSession[]

  @@map("super_admins")
}

// 2FA für Super Admins (TOTP)
model SuperAdmin2FA {
  id              String   @id @default(cuid())
  superAdminId    String   @unique
  secret          String   // Verschlüsseltes TOTP Secret
  enabled         Boolean  @default(false)
  backupCodes     String?  // JSON Array von Backup-Codes (verschlüsselt)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  superAdmin      SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@map("super_admin_2fa")
}

// Super Admin Sessions (separate Session-Verwaltung)
model SuperAdminSession {
  id              String   @id @default(cuid())
  superAdminId    String
  token           String   @unique // JWT Token ID oder Session Token
  expiresAt       DateTime
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  superAdmin      SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@index([token])
  @@map("super_admin_sessions")
}

// Audit Log für alle Super Admin Aktionen
model AuditLog {
  id              String   @id @default(cuid())
  superAdminId    String
  action          String   // z.B. "organization.suspend", "subscription.create", "template.update"
  entityType      String   // z.B. "organization", "subscription", "template"
  entityId        String   // ID der betroffenen Entity
  before          String?  // JSON: Zustand vor der Änderung
  after           String?  // JSON: Zustand nach der Änderung
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime @default(now())

  superAdmin      SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: SetNull)

  @@index([superAdminId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

// Abonnements (Subscription-Management)
model Subscription {
  id                    String   @id @default(cuid())
  organizationId        String   @unique // Referenz zu Organization (keine FK - Isolation)
  plan                  String   // free | starter | professional | enterprise
  status                String   @default("active") // active | canceled | past_due | trialing
  stripeSubscriptionId  String?  @unique // Stripe Subscription ID
  stripeCustomerId      String?  // Stripe Customer ID
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean  @default(false)
  canceledAt            DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("subscriptions")
}

// Feature Flags (System-weite Features)
model Feature {
  id              String   @id @default(cuid())
  key             String   @unique // z.B. "advanced_analytics", "api_access", "custom_templates"
  name            String
  description     String?
  defaultEnabled  Boolean  @default(false) // Standard für neue Organizations
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organizationFeatures OrganizationFeature[]

  @@map("features")
}

// Feature-Toggles pro Organization
model OrganizationFeature {
  id              String   @id @default(cuid())
  organizationId  String   // Referenz zu Organization (keine FK - Isolation)
  featureId       String
  enabled         Boolean  @default(false)
  enabledAt       DateTime?
  disabledAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  feature         Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  // Eine Organization kann ein Feature nur einmal haben
  @@unique([organizationId, featureId])
  @@index([organizationId])
  @@map("organization_features")
}

// Template-Management (für DPP-Templates)
model Template {
  id              String   @id @default(cuid())
  name            String
  category        String?  // z.B. "TEXTILE", "FURNITURE", "OTHER"
  industry        String?  // z.B. "textile", "furniture", "electronics"
  version         Int      @default(1)
  schemaJson      String   // JSON Schema für das Template
  description     String?  // Beschreibung des Templates
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // Super Admin ID (optional für Audit)

  @@unique([name, version])
  @@index([category])
  @@index([industry])
  @@index([isActive])
  @@map("templates")
}

