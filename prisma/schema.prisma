generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String          @id @default(cuid())
  email                     String          @unique
  password                  String
  name                      String?
  systemRole                String?
  isPlatformAdmin           Boolean         @default(false)
  emailVerified             Boolean         @default(false)
  verificationToken         String?         @unique
  verificationTokenExpires  DateTime?
  passwordResetToken        String?         @unique
  passwordResetTokenExpires DateTime?
  totpSecret                String?
  totpEnabled               Boolean         @default(false)
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  dppPermissions            DppPermission[]
  publishedVersions         DppVersion[]
  memberships               Membership[]

  @@map("users")
}

model Organization {
  id          String       @id @default(cuid())
  name        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  licenseTier String       @default("free")
  status      String       @default("active")
  dpps        Dpp[]
  memberships Membership[]
  subscription Subscription?

  @@map("organizations")
}

model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           String       @default("ORG_MEMBER")
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

model Dpp {
  id                    String          @id @default(cuid())
  name                  String
  description           String?
  category              String          @default("OTHER")
  sku                   String?
  gtin                  String?
  brand                 String?
  countryOfOrigin       String?
  materials             String?
  materialSource        String?
  careInstructions      String?
  isRepairable          String?
  sparePartsAvailable   String?
  lifespan              String?
  conformityDeclaration String?
  disposalInfo          String?
  takebackOffered       String?
  takebackContact       String?
  secondLifeInfo        String?
  status                String          @default("DRAFT") // DRAFT | PUBLISHED | DEPRECATED
  supersedesDppId       String?         // ID des DPPs, der durch diesen DPP ersetzt wurde (für Fehlklassifikationen)
  organizationId        String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  media                 DppMedia[]
  permissions           DppPermission[]
  versions              DppVersion[]
  content               DppContent[]
  organization          Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("dpps")
}

model DppMedia {
  id         String   @id @default(cuid())
  dppId      String
  fileName   String
  fileType   String
  fileSize   Int
  storageUrl String
  uploadedAt DateTime @default(now())
  dpp        Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)

  @@map("dpp_media")
}

model DppVersion {
  id                    String   @id @default(cuid())
  dppId                 String
  version               Int
  name                  String
  description           String?
  category              String
  sku                   String?
  gtin                  String?
  brand                 String?
  countryOfOrigin       String?
  materials             String?
  materialSource        String?
  careInstructions      String?
  isRepairable          String?
  sparePartsAvailable   String?
  lifespan              String?
  conformityDeclaration String?
  disposalInfo          String?
  takebackOffered       String?
  takebackContact       String?
  secondLifeInfo        String?
  createdAt             DateTime @default(now())
  createdByUserId       String
  publicUrl             String?
  qrCodeImageUrl        String?
  createdBy             User     @relation(fields: [createdByUserId], references: [id])
  dpp                   Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)

  @@unique([dppId, version])
  @@map("dpp_versions")
}

model DppPermission {
  id        String   @id @default(cuid())
  dppId     String
  userId    String
  role      String
  sections  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  dpp       Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dppId, userId, role])
  @@map("dpp_permissions")
}

model SuperAdmin {
  id                        String              @id @default(cuid())
  email                     String              @unique
  passwordHash              String
  name                      String?
  role                      String              @default("support_admin")
  isActive                  Boolean             @default(true)
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  lastLoginAt               DateTime?
  passwordResetToken        String?             @unique
  passwordResetTokenExpires DateTime?
  auditLogs                 AuditLog[]
  twoFactorAuth             SuperAdmin2FA?
  sessions                  SuperAdminSession[]

  @@map("super_admins")
}

model SuperAdmin2FA {
  id           String     @id @default(cuid())
  superAdminId String     @unique
  secret       String
  enabled      Boolean    @default(false)
  backupCodes  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@map("super_admin_2fa")
}

model SuperAdminSession {
  id           String     @id @default(cuid())
  superAdminId String
  token        String     @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime   @default(now())
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@index([token])
  @@map("super_admin_sessions")
}

model AuditLog {
  id           String     @id @default(cuid())
  superAdminId String
  action       String
  entityType   String
  entityId     String
  before       String?
  after        String?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime   @default(now())
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: SetNull)

  @@index([superAdminId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

model Subscription {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                 String       @default("basic") // basic | pro | premium
  status               String       @default("trial_active") // trial_active | active | past_due | canceled | expired
  trialExpiresAt       DateTime?    // Nullable, nur gesetzt wenn status = trial_active
  trialStartedAt       DateTime?
  stripeSubscriptionId String?      @unique
  stripeCustomerId     String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean      @default(false)
  canceledAt           DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@map("subscriptions")
}

model Feature {
  id                   String                @id @default(cuid())
  key                  String                @unique
  name                 String
  description          String?
  defaultEnabled       Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  organizationFeatures OrganizationFeature[]

  @@map("features")
}

model OrganizationFeature {
  id             String    @id @default(cuid())
  organizationId String
  featureId      String
  enabled        Boolean   @default(false)
  enabledAt      DateTime?
  disabledAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  feature        Feature   @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureId])
  @@index([organizationId])
  @@map("organization_features")
}

model Template {
  id                String          @id @default(cuid())
  name              String
  industry          String?
  version           Int             @default(1)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  category          String
  description       String?
  createdBy         String?
  status            String          @default("draft")
  effectiveFrom     DateTime?
  supersedesVersion Int?
  categoryLabel     String?
  blocks            TemplateBlock[]

  @@unique([category, version])
  @@unique([category, version, status])
  @@index([category])
  @@index([status])
  @@index([category, status])
  @@index([industry])
  @@map("templates")
}

model TemplateBlock {
  id         String          @id @default(cuid())
  templateId String
  name       String
  order      Int             @default(0)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  template   Template        @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fields     TemplateField[]

  @@index([templateId])
  @@index([templateId, order])
  @@map("template_blocks")
}

model TemplateField {
  id                  String        @id @default(cuid())
  blockId             String
  templateId          String
  label               String
  key                 String
  type                String
  required            Boolean       @default(false)
  config              String?
  order               Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  regulatoryRequired  Boolean       @default(false)
  introducedInVersion Int           @default(1)
  deprecatedInVersion Int?
  regulatoryMapping   String?
  block               TemplateBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@unique([templateId, key])
  @@index([blockId])
  @@index([templateId])
  @@index([blockId, order])
  @@map("template_fields")
}

model FeatureRegistry {
  id                        String      @id @default(cuid())
  key                       String      @unique
  name                      String
  description               String?
  category                  String      // core | content | interaction | styling | publishing
  capabilityKey             String?     // Optional: Maps to capability (for compatibility)
  minimumPlan               String      // basic | pro | premium
  requiresActiveSubscription Boolean    @default(true)
  requiresPublishingCapability Boolean  @default(false)
  visibleInTrial            Boolean     @default(true)
  usableInTrial             Boolean     @default(true)
  configSchema              String?     // JSON Schema als String
  enabled                   Boolean     @default(true)
  defaultForNewDpps         Boolean     @default(false)
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  blockTypes                BlockType[]

  @@index([category])
  @@index([minimumPlan])
  @@map("feature_registry")
}

model BlockType {
  id                String          @id @default(cuid())
  featureRegistryId String?
  featureRegistry   FeatureRegistry? @relation(fields: [featureRegistryId], references: [id], onDelete: SetNull)
  key               String          @unique
  name              String
  description       String?
  category          String          // content | interaction | styling
  configSchema      String          // JSON Schema für Block Config
  defaultConfig     String?         // Default JSON Config
  supportsStyling   Boolean         @default(false)
  requiresPublishing Boolean        @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([category])
  @@map("block_types")
}

model DppContent {
  id            String   @id @default(cuid())
  dppId         String
  dpp           Dpp      @relation(fields: [dppId], references: [id], onDelete: Cascade)
  versionId     String?  // Optional: Link zu published version
  isPublished   Boolean  @default(false)
  blocks        Json     // Array von Block Objects
  styling       Json?    // Global styling config (nur wenn capability vorhanden)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?

  @@index([dppId])
  @@index([dppId, isPublished])
  @@map("dpp_content")
}
